// pages/LibraryChatPage.ets (ä¿®å¤ç‰ˆ)
import { ChatMessage, LibraryQueryRequest, LibraryAgentResponse, QuickAction, ChatMessageData } from '../model/Book';
import { LibraryService, sendChatQueryStream } from '../service/LibraryService';
import { Book } from '../model/Book';
import { router } from '@kit.ArkUI';

@Entry
@Component
export struct LibraryChatPage {
  @State messages: ChatMessage[] = [
    {
      id: 1,
      role: 'assistant',
      content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ ¡å›­å›¾ä¹¦é¦†æ™ºèƒ½åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨æœç´¢å›¾ä¹¦ã€æŸ¥è¯¢å€Ÿé˜…çŠ¶æ€ã€äº†è§£å›¾ä¹¦é¦†è§„åˆ™ç­‰ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ',
      timestamp: new Date().toISOString(),
      type: 'WELCOME'
    }
  ];
  @State inputText: string = '';
  @State isLoading: boolean = false;

  private sessionId: number = Date.now();

  aboutToAppear() {
    const params = router.getParams();
    if (params) {
      const paramsObj = params as Record<string, string>; // ä½¿ç”¨å…·ä½“ç±»å‹
      const initialQuery = paramsObj['initialQuery'];
      if (initialQuery && initialQuery.trim()) {
        this.inputText = initialQuery;
        this.sendMessage();
      }
    }
  }

  build() {
    Column() {
      // å¿«æ·æ“ä½œæŒ‰é’®
      Scroll() {
        Row({ space: 8 }) {
          this.buildQuickAction('æœç´¢å›¾ä¹¦', 'search')
          this.buildQuickAction('å€Ÿé˜…çŠ¶æ€', 'status')
          this.buildQuickAction('å¼€æ”¾æ—¶é—´', 'hours')
          this.buildQuickAction('çƒ­é—¨æ¨è', 'popular')
        }
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)

      // èŠå¤©æ¶ˆæ¯åˆ—è¡¨
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.messages, (message: ChatMessage) => {
            this.buildMessageItem(message)
          })
        }
        .width('100%')
        .padding({ top: 16, bottom: 16 })
      }
      .width('100%')
      .height('70%')
      .scrollBar(BarState.Off)

      // è¾“å…¥åŒºåŸŸ
      Row() {
        TextInput({ placeholder: 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...', text: this.inputText })
          .width('80%')
          .height(40)
          .fontSize(14)
          .padding({ left: 12, right: 12 })
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .onChange((value: string) => {
            this.inputText = value;
          })

        if (this.isLoading) {
          LoadingProgress()
            .width(24)
            .height(24)
            .color('#007DFF')
            .margin({ left: 12 })
        } else {
          Button('å‘é€', { type: ButtonType.Normal })
            .fontSize(14)
            .backgroundColor('#007DFF')
            .borderRadius(20)
            .width(60)
            .height(40)
            .margin({ left: 12 })
            .onClick(() => {
              this.sendMessage();
            })
        }
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 16 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder
  buildQuickAction(text: string, action: string) {
    Text(text)
      .fontSize(13)
      .fontColor('#007DFF')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor('#E6F2FF')
      .borderRadius(20)
      .onClick(() => {
        this.handleQuickAction(action);
      })
  }

  @Builder
  buildMessageItem(message: ChatMessage) {
    if (message.role === 'user') {
      // ç”¨æˆ·æ¶ˆæ¯
      Row() {
        Blank()
        Column() {
          Text(message.content)
            .fontSize(14)
            .fontColor('#FFFFFF')
            .padding({ left: 12, right: 12, top: 8, bottom: 8 })
            .backgroundColor('#007DFF')
            .borderRadius(12)
            .width('70%')
        }
      }
      .width('100%')
      .padding({ right: 16 })
    } else {
      // åŠ©æ‰‹æ¶ˆæ¯
      Row() {
        Column({ space: 12 }) {
          // åŠ©æ‰‹å›å¤
          Column() {
            Text(message.content)
              .fontSize(14)
              .fontColor('#333333')
              .padding({ left: 12, right: 12, top: 8, bottom: 8 })
              .backgroundColor('#FFFFFF')
              .borderRadius(12)
              .width('70%')
          }

          // å»ºè®®æ–‡æœ¬ - ä½¿ç”¨ArkUIçš„æ¡ä»¶æ¸²æŸ“
          if (message.suggestion) {
            Text(`ğŸ’¡ ${message.suggestion}`)
              .fontSize(12)
              .fontColor('#666666')
              .padding({ left: 12, right: 12, top: 4, bottom: 4 })
              .backgroundColor('#F8F8F8')
              .borderRadius(8)
              .width('70%')
          }

          // å¿«é€Ÿæ“ä½œæŒ‰é’® - ä½¿ç”¨ArkUIçš„æ¡ä»¶æ¸²æŸ“
          if (message.quickActions && message.quickActions.length > 0) {
            Row({ space: 8 }) {
              ForEach(message.quickActions, (action: QuickAction) => {
                Text(action.text)
                  .fontSize(12)
                  .fontColor('#007DFF')
                  .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                  .backgroundColor('#E6F2FF')
                  .borderRadius(15)
                  .onClick(() => {
                    this.handleQuickAction(action.action);
                  })
              })
            }
            .width('100%')
            .padding({ left: 8 })
          }

          // å›¾ä¹¦æ¨è - ä½¿ç”¨ArkUIçš„æ¡ä»¶æ¸²æŸ“
          if (message.displayBooks && message.displayBooks.length > 0) {
            this.renderBookList(message.displayBooks)
          }
        }
        .alignItems(HorizontalAlign.Start)
        Blank()
      }
      .width('100%')
      .padding({ left: 16 })
    }
  }

  // çº¯UIçš„ renderBookList æ–¹æ³•
  @Builder
  renderBookList(books: Book[]) {
    Column({ space: 8 }) {
      Text('ğŸ“š ç›¸å…³å›¾ä¹¦')
        .fontSize(12)
        .fontColor('#666666')
        .margin({ bottom: 4 })

      ForEach(books, (book: Book) => {
        this.renderBookItem(book)
      })
    }
    .width('100%')
    .padding({ left: 4 })
  }

  private shouldShowBooks(message: ChatMessage): boolean {
    if (!message.data) return false;
    if (message.type !== 'BOOK_SEARCH' && message.type !== 'BOOK_RECOMMENDATION') return false;

    const data = message.data as ChatMessageData;
    const books = data.books || data.recommendations || data.searchResults || data.popularBooks;
    return !!books && books.length > 0;
  }

  // æ·»åŠ æ¸²æŸ“ä¹¦ç±çš„æ–¹æ³•
  @Builder
  renderBookItem(book: Book) {
    Row() {
      Column() {
        if (book.coverUrl && book.coverUrl.trim() !== '') {
          Image(book.coverUrl)
            .width(40)
            .height(50)
            .objectFit(ImageFit.Cover)
            .borderRadius(4)
        } else {
          Column() {
            Text(book.title?.charAt(0) || 'ä¹¦')
              .fontSize(12)
              .fontColor('#FFFFFF')
          }
          .width(40)
          .height(50)
          .backgroundColor('#007DFF')
          .borderRadius(4)
          .justifyContent(FlexAlign.Center)
        }
      }

      Column({ space: 2 }) {
        Text(book.title)
          .fontSize(12)
          .fontColor('#333333')
          .fontWeight(FontWeight.Medium)
          .maxLines(1)

        Text(`ä½œè€…: ${book.author}`)
          .fontSize(11)
          .fontColor('#666666')
          .maxLines(1)

        Row() {
          Text(`åº“å­˜: ${book.availableCopies}/${book.totalCopies}`)
            .fontSize(10)
            .fontColor(book.availableCopies > 0 ? '#4CAF50' : '#F44336')

          Blank()

          Text('æŸ¥çœ‹è¯¦æƒ…')
            .fontSize(10)
            .fontColor('#007DFF')
        }
        .width('100%')
        .margin({ top: 2 })
      }
      .margin({ left: 8 })
      .width('65%')
    }
    .width('100%')
    .padding({ left: 8, right: 8, top: 6, bottom: 6 })
    .backgroundColor('#F8F8F8')
    .borderRadius(8)
    .onClick(() => {
      router.pushUrl({
        url: 'pages/BookDetailPage',
        params: { bookId: book.id }
      });
    })
  }

  async sendMessage() {
    if (!this.inputText.trim()) return;

    const userMessage: ChatMessage = {
      id: Date.now(),
      role: 'user',
      content: this.inputText.trim(),
      timestamp: new Date().toISOString()
    };

    this.messages.push(userMessage);
    const queryText = this.inputText;
    this.inputText = '';
    this.isLoading = true;

    try {
      const request: LibraryQueryRequest = {
        query: queryText,
        sessionId: this.sessionId
      };

      // åˆ›å»ºä¸€ä¸ªç©ºçš„åŠ©æ‰‹æ¶ˆæ¯
      const initialAssistantMessage: ChatMessage = {
        id: Date.now() + 1,
        role: 'assistant',
        content: '', // åˆå§‹ä¸ºç©º
        timestamp: new Date().toISOString(),
        type: 'TEXT',
        data: {},
        quickActions: [],
        needsFurtherHelp: false
      };

      // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
      this.messages.push(initialAssistantMessage);
      const assistantMessageIndex = this.messages.length - 1;

      // ä½¿ç”¨PromiseåŒ…è£…SSEè¯·æ±‚
      await new Promise<void>((resolve, reject) => {
        let fullResponse = '';

        sendChatQueryStream(request, {
          onContent: (content: string) => {
            fullResponse += content; // ç´¯ç§¯å†…å®¹
            // åˆ›å»ºæ–°çš„æ¶ˆæ¯æ•°ç»„ä»¥è§¦å‘UIæ›´æ–°
            const newMessages: ChatMessage[] = [];
            for (let i = 0; i < this.messages.length; i++) {
              if (i === assistantMessageIndex) {
                // æ‰‹åŠ¨å¤åˆ¶å¯¹è±¡å±æ€§ï¼Œé¿å…ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦
                const updatedMessage: ChatMessage = {
                  id: this.messages[i].id,
                  role: this.messages[i].role,
                  content: fullResponse,
                  timestamp: this.messages[i].timestamp,
                  type: this.messages[i].type,
                  data: this.messages[i].data,
                  suggestion: this.messages[i].suggestion,
                  quickActions: this.messages[i].quickActions,
                  needsFurtherHelp: this.messages[i].needsFurtherHelp,
                  displayBooks: this.messages[i].displayBooks
                };
                newMessages.push(updatedMessage);
              } else {
                newMessages.push(this.messages[i]);
              }
            }
            this.messages = newMessages;
          },
          onEnd: () => {
            resolve(); // æµç»“æŸæ—¶è§£å†³Promise
          },
          onError: (error: string) => {
            reject(new Error(error)); // é”™è¯¯æ—¶æ‹’ç»Promise
          }
        });
      });

    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);

      // åˆ›å»ºé”™è¯¯æ¶ˆæ¯
      const errorMessage: ChatMessage = {
        id: Date.now() + 1,
        role: 'assistant',
        content: 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†é—®é¢˜ã€‚è¯·ç¨åé‡è¯•æˆ–è”ç³»å›¾ä¹¦é¦†ç®¡ç†å‘˜ã€‚',
        timestamp: new Date().toISOString(),
        type: 'ERROR'
      };

      // æ›¿æ¢æœ€åä¸€æ¡æ¶ˆæ¯ï¼ˆç©ºçš„åŠ©æ‰‹æ¶ˆæ¯ï¼‰ä¸ºé”™è¯¯æ¶ˆæ¯
      const newMessages: ChatMessage[] = [];
      for (let i = 0; i < this.messages.length; i++) {
        if (i === this.messages.length - 1) {
          newMessages.push(errorMessage);
        } else {
          newMessages.push(this.messages[i]);
        }
      }
      this.messages = newMessages;
    } finally {
      this.isLoading = false;
      this.scrollToBottom();
    }
  }

  async handleQuickAction(action: string) {
    let query = '';

    switch (action) {
      case 'search':
        query = 'æˆ‘æƒ³æœç´¢å›¾ä¹¦';
        break;
      case 'status':
        query = 'æˆ‘çš„å€Ÿé˜…çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿ';
        break;
      case 'hours':
        query = 'å›¾ä¹¦é¦†ä»€ä¹ˆæ—¶å€™å¼€é—¨ï¼Ÿ';
        break;
      case 'popular':
        query = 'æœ‰ä»€ä¹ˆçƒ­é—¨å›¾ä¹¦æ¨èå—ï¼Ÿ';
        break;
      case 'view_popular_books':
        query = 'çœ‹çœ‹çƒ­é—¨å›¾ä¹¦';
        break;
      case 'view_borrow_records':
        query = 'æŸ¥çœ‹æˆ‘çš„å€Ÿé˜…è®°å½•';
        break;
      case 'view_library_rules':
        query = 'å›¾ä¹¦é¦†æœ‰ä»€ä¹ˆè§„åˆ™ï¼Ÿ';
        break;
      case 'view_library_hours':
        query = 'å›¾ä¹¦é¦†å¼€æ”¾æ—¶é—´æ˜¯ä»€ä¹ˆï¼Ÿ';
        break;
      case 'borrow_popular_books':
        query = 'æ¨èä¸€äº›å¯ä»¥å€Ÿé˜…çš„çƒ­é—¨å›¾ä¹¦';
        break;
      default:
        query = action;
    }

    this.inputText = query;
    this.sendMessage();
  }

  scrollToBottom() {
    // è¿™é‡Œå¯ä»¥å®ç°æ»šåŠ¨åˆ°åº•éƒ¨çš„é€»è¾‘
  }
}
